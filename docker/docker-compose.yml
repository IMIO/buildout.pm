version: '2.4'
services:
  libreoffice:
    image: imiobe/libreoffice:still
    command: soffice --headless --norestore --accept="socket,host=libreoffice,port=2002,tcpNoDelay=1;urp;StarOffice.ServiceManager"
    expose:
      - "2002"
    volumes:
      - tmp:/tmp
      - vartmp:/var/tmp
    networks:
      - internal
    labels:
      SERVICE_NAME: "libreoffice"
    restart:
      unless-stopped
    mem_limit: 200M
    mem_reservation: 150M
  zeo:
    image: imiobe/iadelib:latest
    command: zeoserver
    environment:
      - MOUNTPOINT=demo
      - HOSTNAME=zeo
    volumes:
      - ../var/:/data
      - tmp:/tmp
      - vartmp:/var/tmp
    networks:
      - internal
    labels:
      SERVICE_NAME: "zeo"
#    restart:
#      unless-stopped
  instance1:
    image: imiobe/iadelib:latest
    command: instance
    ports:
      - "20081:8081"
    networks:
      - internal
      - external
    depends_on:
      - zeo
      - libreoffice
      - worker-cron
    environment:
      - ZEO_CLIENT_CACHE_SIZE=1000MB
      - ZODB_CACHE_SIZE=100000
      - CLUSTER=iadelib_pm42
      - MOUNTPOINT=demo
      - HOSTNAME=instance1
      - PLONE_PATH=demo/demo
    volumes:
      - ../var/:/data
      - tmp:/tmp
      - vartmp:/var/tmp
    healthcheck:
      test: "curl -f localhost:8081/$$PLONE_PATH/@@ok"
    labels:
      SERVICE_NAME: "instance1"
  instance2:
    image: imiobe/iadelib:latest
    command: instance
    ports:
      - "20082:8081"
    networks:
      - internal
      - external
    depends_on:
      - zeo
      - libreoffice
      - worker-cron
    environment:
      - ZEO_CLIENT_CACHE_SIZE=1000MB
      - ZODB_CACHE_SIZE=100000
      - CLUSTER=iadelib_pm42
      - MOUNTPOINT=demo
      - HOSTNAME=instance2
      - PLONE_PATH=demo/demo
    volumes:
      - ../var/:/data
      - tmp:/tmp
      - vartmp:/var/tmp
    healthcheck:
      test: "curl -f localhost:8081/$$PLONE_PATH/@@ok"
    labels:
      SERVICE_NAME: "instance2"
  instance3:
    image: imiobe/iadelib:latest
    command: instance
    ports:
      - "20083:8081"
    networks:
      - internal
      - external
    depends_on:
      - zeo
      - libreoffice
      - worker-cron
    environment:
      - ZEO_CLIENT_CACHE_SIZE=1000MB
      - ZODB_CACHE_SIZE=100000
      - ADMIN_PASSWORD=tata
      - CLUSTER=iadelib_pm42
      - MOUNTPOINT=demo
      - HOSTNAME=instance3
      - PLONE_PATH=demo/demo
    healthcheck:
      test: "curl -f localhost:8081/$$PLONE_PATH/@@ok"
    volumes:
      - ../var/:/data
      - tmp:/tmp
      - vartmp:/var/tmp
    labels:
      SERVICE_NAME: "instance3"
#    restart:
#      unless-stopped
  worker-cron:
    image: imiobe/iadelib:latest
    command: instance-cron
    ports:
      - "8087:8087"
    networks:
      - internal
      - external
    depends_on:
      - zeo
    environment:
      - ZEO_CLIENT_CACHE_SIZE=1000MB
      - ZODB_CACHE_SIZE=100000
      - ADMIN_PASSWORD=tata
      - PUBLIC_URL=http://localhost/PM
      - PLONE_PATH=demo/demo
      - CLUSTER=iadelib_pm42
      - MOUNTPOINT=demo
      - HOSTNAME=worker-cron
    volumes:
      - ../var/:/data
      - tmp:/tmp
      - vartmp:/var/tmp
    healthcheck:
      test: "curl -f localhost:8087/$$PLONE_PATH/@@ok"
    labels:
      SERVICE_NAME: "worker-cron"
    restart:
      unless-stopped
  worker-async:
    image: imiobe/iadelib:latest
    command: instance-async
    networks:
      - internal
    depends_on:
      - zeo
      - libreoffice
      - worker-cron
    environment:
      - ZEO_CLIENT_CACHE_SIZE=1000MB
      - ZODB_CACHE_SIZE=100000
      - ADMIN_PASSWORD=tata
      - CLUSTER=iadelib_pm42
      - MOUNTPOINT=demo
      - HOSTNAME=worker-async
      - PLONE_PATH=demo/demo
    healthcheck:
      test: "curl -f localhost:8089/$$PLONE_PATH/@@ok"
    volumes:
      - ../var/:/data
      - tmp:/tmp
      - vartmp:/var/tmp
    labels:
      SERVICE_NAME: "worker-async"
#    restart:
#      unless-stopped
  worker-amqp:
    image: imiobe/iadelib:latest
    command: instance-amqp
    ports:
      - "20085:8286"
    networks:
      - internal
      - external
    depends_on:
      - zeo
      - worker-cron
    environment:
      - ZEO_CLIENT_CACHE_SIZE=1000MB
      - ZODB_CACHE_SIZE=100000
      - ADMIN_PASSWORD=tata
      - CLUSTER=iadelib_pm42
      - MOUNTPOINT=demo
      - PLONE_PATH=demo/demo
      - MQ_CLIENT_ID
      - MQ_WS_URL
      - MQ_WS_LOGIN
      - MQ_WS_PASSWORD
      - MQ_HOST
      - MQ_PORT
      - MQ_LOGIN
      - MQ_PASSWORD
      - HOSTNAME=worker-amqp
    healthcheck:
      test: "curl -f localhost:8286/$$PLONE_PATH/@@ok"
    volumes:
      - ../var/:/data
      - tmp:/tmp
      - vartmp:/var/tmp
    labels:
      SERVICE_NAME: "worker-cron"
#    restart:
#      unless-stopped
  maintenance:
    image: imiobe/iadelib:latest
    entrypoint: bash
    ports:
      - "20089:8080"
    networks:
      - internal
      - external
    depends_on:
      - zeo
      - libreoffice
      - worker-cron
    environment:
      - ZEO_CLIENT_CACHE_SIZE=1000MB
      - ZODB_CACHE_SIZE=100000
      - ADMIN_PASSWORD=tata
      - CLUSTER=iadelib_pm42
      - MOUNTPOINT=demo
      - HOSTNAME=maintenance
      - PLONE_PATH=demo/demo
    healthcheck:
      test: "curl -f localhost:8080/$$PLONE_PATH/@@ok"
    volumes:
      - ../var/:/data
      - tmp:/tmp
      - vartmp:/var/tmp
    labels:
      SERVICE_NAME: "maintenance"
volumes:
  tmp:
  vartmp:

networks:
  internal:
    internal: true
  external:
