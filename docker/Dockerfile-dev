FROM imiobe/iadelib:latest

ARG PROFILE="communes-dev.cfg"

WORKDIR /
USER root
COPY --chown=imio *.cfg *.conf requirements.txt Makefile docker/docker-initialize.py docker/*.sh /plone/
RUN apt-get update \
  && apt-get install -qqy --no-install-recommends \
  && buildDeps="build-essential \
                python-dev-is-python2 \
                lynx \
                cmake \
                make \
                wget \
                python3-pip \
                libpq-dev \
                libreadline-dev \
                gcc \
                libc6-dev \
                libpcre3-dev \
                libssl-dev \
                libxml2-dev \
                libxslt1-dev \
                libbz2-dev \
                libffi-dev \
                libjpeg62-dev \
                libopenjp2-7-dev \
                zlib1g-dev \
                libldap2-dev \
                libwebp-dev \
                libsasl2-dev \
                libldap2-dev \
                libsigc++-2.0-dev" \
  && apt-get install -qqy --no-install-recommends $buildDeps git subversion \
  && rm -rf /var/lib/apt/lists/* \
  && pip install "virtualenv>=20.7.2" \
  && gem install docsplit

WORKDIR /plone

RUN sed -i "s/\${buildout:directory}\/var/\/data/g" *.cfg \
  && echo "[buildout]" > buildout.cfg \
  && echo "extends =" >> buildout.cfg \
  && echo "    $PROFILE" >> buildout.cfg \
  && echo "    amqp.cfg" >> buildout.cfg \
  && echo "    ldap.cfg" >> buildout.cfg \
  && echo "    docker-dev.cfg" >> buildout.cfg \
  && sed -ie "s#Products.MeetingCommunes:zcity#Products.MeetingCommunes:demo#" base.cfg \
  && su -c "virtualenv -p python2 ." -s /bin/sh imio \
  && su -c "bin/pip install 'python-ldap==2.4.15' -r requirements.txt" -s /bin/sh imio \
  && su -c "bin/buildout -t 30 -N" -s /bin/sh imio \
  && rm -rf develop-eggs/ var/blobstorage/ var/filestorage/

USER imio
EXPOSE 8081
ENTRYPOINT ["/plone/docker-entrypoint.sh"]
CMD ["instance"]